###################################################################################################################
# There are multiple charts in this file, please copy each section into a different chart (starts with a comment)
####################################################################################################################
---
###############################################
# Battery prediction chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Home Battery Prediction
  show_states: true
  colorize_states: true
graph_span: 60h
span:
  start: minute
  offset: '-12h'
now:
  show: true
yaxis:
  - min: 0
    max: 9.54
series:
  - entity: predbat.soc_kw_h0
    stroke_width: 1
    curve: stepline
    name: actual
    extend_to: now
    show:
      in_header: raw
  - entity: predbat.soc_kw
    stroke_width: 1
    curve: smooth
    name: base
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.soc_kw_best
    stroke_width: 3
    curve: smooth
    name: best
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.soc_kw_best10
    stroke_width: 1
    curve: smooth
    name: best10
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.best_charge_limit_kw
    stroke_width: 4
    curve: stepline
    name: charge_limit_best
    type: area
    opacity: 0.2
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.charge_limit_kw
    stroke_width: 1
    curve: stepline
    name: charge_limit_base
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.best_export_limit_kw
    stroke_width: 2
    curve: stepline
    name: export_best
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.record
    stroke_width: 3
    curve: stepline
    name: record
    type: area
    opacity: 0.5
    color: black
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.soc_kw_base10
    stroke_width: 1
    curve: smooth
    name: base10
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
###############################################
# This is a cost chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Home cost prediction
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: day
  offset: +0h
now:
  show: true
series:
  - entity: predbat.metric
    stroke_width: 1
    curve: smooth
    name: base
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.best_metric
    stroke_width: 2
    curve: smooth
    name: best
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.best10_metric
    stroke_width: 1
    curve: smooth
    name: best10
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.cost_today
    stroke_width: 1
    curve: smooth
    name: actual
    extend_to: now
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.cost_today_import
    stroke_width: 1
    curve: smooth
    name: actual_import
    extend_to: now
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.cost_today_export
    stroke_width: 1
    curve: smooth
    name: actual_export
    extend_to: now
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), -value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.base10_metric
    stroke_width: 1
    curve: smooth
    name: base10
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
###############################################
# Energy rate chart
# NOTE: Tune the value*5 in the grid_power_best part to make the power peak line up with the energy rates
# so you can see charging/discharging aligned with slots
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Energy rates
  show_states: true
  colorize_states: true
graph_span: 72h
span:
  start: day
  offset: -24h
now:
  show: true
series:
  - entity: predbat.grid_power_best
    name: power
    stroke_width: 1
    type: area
    opacity: 0.2
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value*5]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.rates
    attribute: threshold
    name: Low threshold
    curve: stepline
    stroke_width: 2
  - entity: predbat.rates_export
    attribute: threshold
    name: High threshold
    curve: stepline
    stroke_width: 2
  - entity: predbat.rates
    stroke_width: 2
    curve: stepline
    name: import
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.rates_export
    stroke_width: 1
    type: area
    opacity: 0.2
    curve: stepline
    name: export
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.rates_gas
    stroke_width: 1
    type: area
    opacity: 0.2
    curve: stepline
    name: gas
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.ppkwh_hour
    stroke_width: 2
    type: line
    curve: stepline
    name: Hourly p/kWh
    extend_to: false
  - entity: predbat.ppkwh_today
    stroke_width: 2
    type: line
    curve: stepline
    name: Today p/kWh
    extend_to: false
###############################################
# Data prediction chart (import/export/pv/load)
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Data prediction
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: minute
  offset: '-1h'
now:
  show: true
yaxis:
  - min: 0
series:
  - entity: predbat.load_energy_h0
    stroke_width: 1
    curve: smooth
    name: load actual
    extend_to: now
  - entity: predbat.import_energy_h0
    stroke_width: 1
    curve: smooth
    name: import actual
    extend_to: now
  - entity: predbat.export_energy_h0
    stroke_width: 1
    curve: smooth
    name: export actual
    extend_to: now
  - entity: predbat.pv_energy_h0
    stroke_width: 1
    curve: smooth
    name: PV actual
    extend_to: now
  - entity: predbat.best_load_energy
    stroke_width: 1
    curve: smooth
    name: load
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.best_pv_energy
    stroke_width: 1
    curve: smooth
    name: pv
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.import_energy
    stroke_width: 1
    curve: smooth
    name: import
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.export_energy
    stroke_width: 1
    curve: smooth
    name: export
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.best_import_energy
    stroke_width: 1
    curve: smooth
    name: best import
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.best_export_energy
    stroke_width: 1
    curve: smooth
    name: best export
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })

##############################################################################################
# Example car battery prediction chart
# Change sensor.tsunami_battery to your own car battery % sensor
##############################################################################################
type: custom:apexcharts-card
header:
  show: true
  title: Car battery prediction
  show_states: true
  colorize_states: true
graph_span: 58h
span:
  start: minute
  offset: '-12h'
now:
  show: true
yaxis:
  - min: 0
    max: 100
series:
  - entity: sensor.tsunami_battery
    stroke_width: 1
    curve: smooth
    name: history
    extend_to: now
  - entity: predbat.car_soc
    stroke_width: 1
    curve: smooth
    name: base
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: predbat.car_soc_best
    stroke_width: 1
    curve: smooth
    name: Best
    show:
      in_header: raw
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })

###############################################
## Power chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Power
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: minute
  offset: '-0h'
now:
  show: true
series:
  - entity: predbat.battery_power_best
    stroke_width: 1
    curve: smooth
    name: battery best
    unit: w
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value*1000.0]); } return res.sort((a, b) => { return
      a[0] - b[0]  })
  - entity: predbat.pv_power_best
    stroke_width: 1
    curve: smooth
    name: pv best
    unit: w
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value*1000.0]); } return res.sort((a, b) => { return
      a[0] - b[0]  })
  - entity: predbat.grid_power_best
    stroke_width: 1
    curve: smooth
    name: grid best
    unit: w
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value*1000.0]); } return res.sort((a, b) => { return
      a[0] - b[0]  })
  - entity: predbat.load_power_best
    stroke_width: 1
    curve: smooth
    name: load best
    unit: w
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value*1000.0]); } return res.sort((a, b) => { return
      a[0] - b[0]  })

###############################################
# Calibration chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Calibration
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: minute
  offset: '-36h'
now:
  show: true
yaxis:
  - min: 0
series:
  - entity: predbat.soc_kw_h0
    stroke_width: 1
    curve: smooth
    name: actual
    extend_to: now
    show:
      in_header: raw
  - entity: predbat.soc_kw_best_h1
    stroke_width: 1
    curve: smooth
    name: h1
    offset: '-1h'
    show:
      in_header: raw
  - entity: predbat.soc_kw_best_h8
    stroke_width: 1
    curve: smooth
    name: h8
    offset: '-8h'
    show:
      in_header: raw
  - entity: predbat.soc_kw_best_h12
    stroke_width: 1
    curve: smooth
    name: h12
    offset: '-12h'
    show:
      in_header: raw
###############################################
# In day adjustment chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: In day adjustment
  show_states: true
  colorize_states: true
graph_span: 24h
span:
  start: day
  offset: '-0h'
now:
  show: true
yaxis:
  - min: 0
series:
  - entity: predbat.load_energy_actual
    stroke_width: 1
    curve: smooth
    name: actual
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.load_energy_predicted
    stroke_width: 1
    curve: smooth
    name: predicted
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.load_energy_adjusted
    stroke_width: 1
    curve: smooth
    name: adjusted
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw

###############################################
# Carbon chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Home cost prediction
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: day
  offset: +0h
now:
  show: true
series:
  - entity: predbat.carbon_today
    stroke_width: 1
    curve: smooth
    name: co2
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    extend_to: now
    show:
      in_header: raw
  - entity: predbat.carbon_best
    stroke_width: 2
    curve: smooth
    name: co2 best
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
    show:
      in_header: raw
  - entity: predbat.carbon_now
    stroke_width: 4
    curve: smooth
    name: Carbon Intensity history
    show:
      in_header: raw
    extend_to: now
  - entity: sensor.carbon_intensity_uk
    unit: g/kWh
    name: Carbon Intensity future
    show:
      legend_value: false
    data_generator: |
      return entity.attributes.forecast.map(obj => {
        return [new Date(obj.from).getTime(), obj.intensity];
      });
    color_threshold:
      - value: 25
        color: darkgreen
        opacity: 1
      - value: 95
        color: green
      - value: 180
        color: gold
      - value: 279
        color: red
      - value: 330
        color: darkred

###############################################
# Daily cost saving chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Daily Cost Savings
  show_states: true
  colorize_states: true
graph_span: 7days
span:
  start: day
  offset: '-6day'
now:
  show: true
series:
  - entity: predbat.savings_yesterday_predbat
    stroke_width: 1
    name: saving_predbat
    type: column
    group_by:
      func: last
      duration: 24hours
  - entity: predbat.savings_yesterday_pvbat
    stroke_width: 1
    name: saving_pvbat
    type: column
    group_by:
      func: last
      duration: 1day
  - entity: predbat.cost_yesterday
    stroke_width: 1
    type: column
    name: actual
    group_by:
      func: last
      duration: 1day

###############################################
# Total cost saving chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Total Cost Saving
  show_states: true
  colorize_states: true
graph_span: 30days
span:
  start: day
  offset: '-29days'
now:
  show: true
series:
  - entity: predbat.savings_total_predbat
    stroke_width: 1
    curve: smooth
    name: Predbat saving
    attribute: pounds
    unit: £
  - entity: predbat.savings_total_pvbat
    stroke_width: 1
    curve: smooth
    name: PV/Battery saving
    attribute: pounds
    unit: £
###############################################
# PV Forecast vs actual chart
###############################################
type: custom:apexcharts-card
header:
  title: Solar forecast
  show: true
  show_states: true
  colorize_states: true
apex_config:
  chart:
    height: 300px
  tooltip:
    enabled: true
    shared: true
    followCursor: true
graph_span: 24h
span:
  start: day
yaxis:
  - id: capacity
    show: true
    opposite: true
    decimals: 0
    max: 100
    min: 0
    apex_config:
      tickAmount: 10
  - id: kWh
    show: true
    min: 0
    apex_config:
      tickAmount: 10
  - id: header_only
    show: false
series:
  - entity: predbat.pv_power
    name: Solar Power
    type: line
    stroke_width: 2
    float_precision: 2
    color: Orange
    yaxis_id: kWh
    unit: kW
    extend_to: now
    show:
      legend_value: true
      in_header: false
    group_by:
      func: avg
      duration: 15m
  - entity: sensor.predbat_pv_today
    name: Forecast
    color: grey
    opacity: 0.3
    stroke_width: 0
    type: area
    time_delta: +15min
    extend_to: false
    yaxis_id: kWh
    show:
      legend_value: false
      in_header: false
    data_generator: |
      return entity.attributes.detailedForecast.map((entry) => {
            return [new Date(entry.period_start), entry.pv_estimate];
          });
  - entity: sensor.predbat_pv_today
    name: Forecast 10%
    color: grey
    opacity: 0.3
    stroke_width: 0
    type: area
    time_delta: +15min
    extend_to: false
    yaxis_id: kWh
    show:
      legend_value: false
      in_header: false
    data_generator: |
      return entity.attributes.detailedForecast.map((entry) => {
            return [new Date(entry.period_start), entry.pv_estimate10];
          });
  - entity: predbat.pv_energy_h0
    yaxis_id: header_only
    name: Today Actual
    stroke_width: 2
    color: Orange
    show:
      legend_value: true
      in_header: true
      in_chart: false
  - entity: sensor.predbat_pv_today
    yaxis_id: header_only
    name: Today Forecast
    color: Grey
    show:
      legend_value: true
      in_header: true
      in_chart: false
  - entity: sensor.predbat_pv_today
    yaxis_id: header_only
    attribute: remaining
    name: Remaining
    color: Grey
    show:
      legend_value: true
      in_header: true
      in_chart: false
###############################################
# Battery temperature chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: Battery Temperature
  show_states: true
  colorize_states: true
graph_span: 5d
span:
  start: day
  offset: "-3day"
now:
  show: true
series:
  - entity: predbat.battery_temperature
    name: temperature
    stroke_width: 1
    type: area
    opacity: 0.2
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: sensor.givtcp_battery_stack_1_bms_temperature
    name: Temperature history
    curve: stepline
    stroke_width: 2
    extend_to: now
###############################################
# PV Forecast chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: PV Forecast
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: day
now:
  show: true
series:
  - entity: sensor.predbat_pv_forecast_h0
    stroke_width: 3
    opacity: 1
    unit: w
    extend_to: now
    type: area
    color: "#a8a8a7"
    name: PV Forecast Hist
  - entity: predbat.pv_power_best
    stroke_width: 3
    opacity: 0.3
    unit: w
    extend_to: now
    type: area
    color: "#f5c43d"
    name: PV Power Actual
  - entity: sensor.predbat_pv_today
    curve: smooth
    name: Forecast
    unit: w
    opacity: 0.3
    color: "#a8a8a7"
    stroke_width: 2
    type: area
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_today
    curve: smooth
    opacity: 0.3
    color: "#6b6b6b"
    type: area
    stroke_width: 2
    name: Forecast 10%
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate10]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_today
    curve: smooth
    opacity: 0.3
    color: "#cccccc"
    type: area
    stroke_width: 2
    name: Forecast 90%
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate90]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_today
    curve: smooth
    opacity: 0.3
    type: area
    color: "#e90a0a"
    stroke_width: 2
    name: Forecast CL
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimateCL]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_tomorrow
    curve: smooth
    opacity: 0.3
    color: "#6b6b6b"
    type: area
    stroke_width: 2
    name: Forecast 10% Tomorrow
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate10]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_tomorrow
    curve: smooth
    opacity: 0.3
    color: "#cccccc"
    type: area
    stroke_width: 2
    name: Forecast 90% Tomorrow
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate90]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_tomorrow
    curve: smooth
    opacity: 0.3
    type: area
    color: "#e90a0a"
    stroke_width: 2
    name: Forecast CL Tomorrow
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimateCL]); }
      return res.sort((a, b) => a[0] - b[0]);
###############################################
# PV Forecast History Chart
###############################################
type: custom:apexcharts-card
header:
  show: true
  title: PV Forecast History
  show_states: true
  colorize_states: true
graph_span: 8d
span:
  start: day
  offset: "-7d"
now:
  show: true
yaxis:
  - max: 4
series:
  - entity: sensor.predbat_pv_forecast_h0
    stroke_width: 3
    opacity: 1
    unit: w
    extend_to: now
    type: area
    color: "#a8a8a7"
    name: PV Forecast Hist
  - entity: predbat.pv_power_best
    stroke_width: 3
    opacity: 0.3
    unit: w
    extend_to: now
    type: area
    color: "#f5c43d"
    name: PV Power Actual
  - entity: sensor.predbat_pv_today
    curve: smooth
    name: Forecast
    unit: w
    opacity: 0.3
    color: "#a8a8a7"
    stroke_width: 2
    type: area
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_today
    curve: smooth
    opacity: 0.3
    color: "#6b6b6b"
    type: area
    stroke_width: 2
    name: Forecast 10%
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate10]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_today
    curve: smooth
    opacity: 0.3
    color: "#cccccc"
    type: area
    stroke_width: 2
    name: Forecast 90%
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimate90]); }
      return res.sort((a, b) => a[0] - b[0]);
  - entity: sensor.predbat_pv_today
    curve: smooth
    opacity: 0.3
    type: area
    color: "#e90a0a"
    stroke_width: 2
    name: Forecast CL
    unit: w
    data_generator: >
      let res = []; for (const item of entity.attributes.detailedForecast) {
      res.push([new Date(item.period_start).getTime(), item.pv_estimateCL]); }
      return res.sort((a, b) => a[0] - b[0]);


###############################################
#------------------------ML Home Load Forecast (excl EV)-------------------------------
###############################################

type: custom:apexcharts-card
header:
  show: true
  title: ML Home Load Forecast (excl EV)
  show_states: true
  colorize_states: true
graph_span: 4d
update_interval: 15min
span:
  start: day
  offset: "-2d"
apex_config:
  legend:
    show: true
now:
  show: true
yaxis:
  - id: forecasts
    show: true
    opposite: true
    decimals: 0
    max: 60
    min: 0
    apex_config:
      tickAmount: 6
  - id: mae
    show: false
    opposite: true
    decimals: 2
    max: auto
    min: -0.1
    apex_config:
      tickAmount: 6
series:
  - entity: sensor.predbat_load_ml_stats
    attribute: load_today
    stroke_width: 2
    extend_to: now
    curve: smooth
    name: Load
    opacity: 0.2
    type: area
    yaxis_id: forecasts
    color: orange
  - entity: sensor.predbat_load_ml_stats
    attribute: load_today
    stroke_width: 3
    extend_to: now
    curve: smooth
    name: Load
    opacity: 1
    type: line
    yaxis_id: forecasts
    color: orange
    show:
      in_header: false
      in_legend: false
  - entity: sensor.predbat_load_ml_forecast
    stroke_width: 3
    curve: smooth
    name: ML Load
    color: red
    opacity: 0.35
    yaxis_id: forecasts
    show:
      in_header: false
      in_legend: true
    data_generator: >
      let res = []; for (const [key, value] of
      Object.entries(entity.attributes.results)) { res.push([new
      Date(key).getTime(), value]); } return res.sort((a, b) => { return a[0] -
      b[0]  })
  - entity: sensor.predbat_load_ml_stats
    attribute: load_today_h1
    stroke_width: 2
    color: green
    curve: smooth
    name: FC
    opacity: 0.6
    type: line
    offset: "-1h"
    extend_to: now
    yaxis_id: forecasts
  - entity: sensor.predbat_load_ml_stats
    attribute: load_today_h8
    stroke_width: 2
    color: purple
    curve: smooth
    name: FC
    opacity: 0.35
    type: line
    offset: "-8h"
    extend_to: now
    yaxis_id: forecasts
  - entity: sensor.predbat_load_ml_stats
    attribute: mae_kwh
    float_precision: 4
    stroke_width: 2
    color: black
    curve: smooth
    name: MAE
    opacity: 1
    type: line
    extend_to: now
    yaxis_id: mae
    transform: |
      if (x === null || x === undefined) return null;
      return Number(parseFloat(x).toFixed(3));

###############################################
#------------------------ML Home Power Forecast (excl EV)-------------------------------
###############################################

type: custom:apexcharts-card
header:
  show: true
  title: ML Home Power Forecast (excl EV)
  show_states: true
  colorize_states: true
graph_span: 4d
update_interval: 15min
span:
  start: day
  offset: "-2d"
apex_config:
  legend:
    show: true
  tooltip:
    shared: true
now:
  show: true
yaxis:
  - id: forecasts
    show: true
    opposite: false
    decimals: 0
    max: 4
    min: 0
    apex_config:
      tickAmount: 12
  - id: temp
    show: true
    opposite: true
    decimals: 0
    max: auto
    min: -10
    apex_config:
      tickAmount: 6
series:
  - entity: sensor.predbat_temperature
    stroke_width: 2
    extend_to: now
    curve: smooth
    name: Temp
    opacity: 1
    type: line
    yaxis_id: temp
    color: blue
  - entity: sensor.predbat_temperature
    name: Temp FC
    type: line
    yaxis_id: temp
    stroke_width: 2
    curve: smooth
    color: blue
    opacity: 0.35
    extend_to: false
    show:
      in_header: false
      in_legend: false
    data_generator: |
      const results = entity.attributes.results;
      if (!results) return [];

      const now = Date.now();

      return Object.entries(results)
        .map(([dt, val]) => [new Date(dt).getTime(), val])
        .filter(([ts, _]) => ts >= now);
  - entity: sensor.predbat_load_ml_stats
    attribute: power_today_now
    stroke_width: 2
    extend_to: now
    curve: smooth
    name: Power
    opacity: 0.2
    type: area
    yaxis_id: forecasts
    color: orange
  - entity: sensor.predbat_load_ml_stats
    attribute: power_today_now
    stroke_width: 2
    extend_to: now
    curve: smooth
    name: Power
    opacity: 1
    type: line
    yaxis_id: forecasts
    color: orange
    show:
      in_header: false
      in_legend: false
  - entity: sensor.predbat_load_ml_stats
    attribute: power_today_h1
    stroke_width: 2
    color: green
    curve: smooth
    name: FC
    opacity: 0.6
    type: line
    offset: "-1h"
    extend_to: now
    yaxis_id: forecasts
  - entity: sensor.predbat_load_ml_stats
    attribute: power_today_h8
    stroke_width: 2
    color: purple
    curve: smooth
    name: FC
    opacity: 0.35
    type: line
    offset: "-8h"
    extend_to: now
    yaxis_id: forecasts
  - entity: sensor.predbat_load_ml_forecast
    name: ML FC
    type: line
    curve: smooth
    stroke_width: 3
    color: red
    opacity: 0.35
    yaxis_id: forecasts
    show:
      in_header: false
    data_generator: |
      const raw = Object.entries(entity.attributes.results || {})
        .map(([ts, v]) => [new Date(ts).getTime(), Number(v)])
        .filter(p => !isNaN(p[0]) && !isNaN(p[1]))
        .sort((a,b) => a[0]-b[0]);

      const res = [];
      for (let i = 1; i < raw.length; i++) {
        const [t1, e1] = raw[i-1];   // previous cumulative kWh
        const [t2, e2] = raw[i];     // current cumulative kWh

        const dt_hours = (t2 - t1) / 3600000;  // ms → hours
        if (dt_hours <= 0) continue;

        const dE = e2 - e1;  // kWh used during interval

        const power_kw = dE / dt_hours;

        res.push([t2, power_kw]);
      }
      return res;
  - entity: sensor.predbat_load_ml_stats
    attribute: power_today_now
    name: Home Power (Avg 1h)
    type: line
    yaxis_id: forecasts
    color: black
    stroke_width: 3
    curve: smooth
    opacity: 1
    extend_to: now
    show:
      in_header: false
      in_legend: false
    group_by:
      func: avg
      duration: 6h
  - entity: sensor.predbat_load_ml_forecast
    name: ML Forecast Power (Avg 6h)
    type: line
    curve: smooth
    stroke_width: 3
    color: black
    opacity: 1
    yaxis_id: forecasts
    show:
      in_header: false
      in_legend: false
    data_generator: |
      // Build raw cumulative kWh points
      const raw = Object.entries(entity.attributes.results || {})
        .map(([ts, v]) => [new Date(ts).getTime(), Number(v)])
        .filter(([t, v]) => !isNaN(t) && !isNaN(v))
        .sort((a, b) => a[0] - b[0]);

      if (raw.length < 2) return [];

      // Convert cumulative kWh -> interval energy (kWh) + duration (ms)
      const intervals = [];
      for (let i = 1; i < raw.length; i++) {
        const [t1, e1] = raw[i - 1];
        const [t2, e2] = raw[i];

        const dt = t2 - t1;              // ms
        if (dt <= 0) continue;

        const dE = e2 - e1;              // kWh used during interval
        if (!isFinite(dE)) continue;

        // Skip resets/backsteps that create negative "power" spikes/dropouts
        if (dE < 0) continue;

        intervals.push([t2, dE, dt]);    // store at interval end time
      }

      if (!intervals.length) return [];

      // Rolling window: 6 hours
      const windowMs = 6 * 60 * 60 * 1000;

      // Optional: require at least 1 hour of data in the window before plotting
      const minCoverageMs = 60 * 60 * 1000;

      // Two-pointer, time-weighted rolling mean: sum(kWh)/sum(hours)
      let sumE = 0;      // kWh
      let sumMs = 0;     // ms
      let j = 0;
      const out = [];

      for (let i = 0; i < intervals.length; i++) {
        const [ti, dEi, dti] = intervals[i];
        sumE += dEi;
        sumMs += dti;

        while (intervals[j][0] < ti - windowMs) {
          sumE -= intervals[j][1];
          sumMs -= intervals[j][2];
          j++;
        }

        if (sumMs <= 0 || sumMs < minCoverageMs) {
          out.push([ti, null]);          // plot gaps until enough window coverage
        } else {
          const avgKw = sumE / (sumMs / 3600000);  // kWh / hours = kW
          out.push([ti, avgKw]);
        }
      }

      return out;
